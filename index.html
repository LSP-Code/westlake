<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Westlake Elite // Immersive v16</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000000; 
            --surface: #141614; 
            --primary: #d2e7d6; 
            --on-primary: #1e3623;
            --primary-container: #3d4b3f;
            --error: #ffb4ab;
            --radius: 2.5vh;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background: var(--bg); 
            color: #e2e3dd;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Lock Screen --- */
        #lock-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .lock-clock { font-size: 15vh; font-weight: 300; color: #fff; }
        .unlock-pill {
            background: var(--primary); color: var(--on-primary); border: none;
            padding: 2.5vh 7vh; border-radius: 10vh; font-weight: 700; font-size: 2.2vh; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* --- Compact Dashboard Layout --- */
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1.5vh 2.5vh 2.5vh 2.5vh; /* Minimized top padding */
            gap: 1.5vh;
        }

        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 10vh; /* Condensed Header */
        }
        .h-time { font-size: 8vh; font-weight: 300; line-height: 1; }
        .h-weather { font-size: 3.5vh; color: var(--primary); }

        .main-content {
            display: flex;
            flex: 1;
            gap: 2vh;
            min-height: 0;
        }

        aside {
            flex: 0 0 26vw;
            display: flex;
            flex-direction: column;
            gap: 1.5vh;
        }

        main {
            flex: 1;
            display: flex;
        }

        .card { 
            background: var(--surface); 
            border-radius: var(--radius); 
            padding: 2vh;
            display: flex; 
            flex-direction: column; 
            border: 1px solid rgba(255,255,255,0.03);
            min-height: 0;
        }

        .label { font-size: 1.1vh; font-weight: 700; color: var(--primary); margin-bottom: 1vh; letter-spacing: 0.1vh; text-transform: uppercase; opacity: 0.7; }

        /* --- Action Controls --- */
        .btn {
            background: var(--primary-container); color: var(--primary);
            border: none; padding: 2vh; border-radius: 1.8vh; font-size: 1.7vh; font-weight: 600;
            margin-bottom: 0.8vh; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 1.2vh;
        }
        .btn-main { background: var(--primary); color: var(--on-primary); }
        .btn-emer { background: #410002; color: var(--error); border: 1px solid rgba(255,180,171,0.1); }

        /* --- Immersive Overlays --- */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; }
        
        /* Floating Exit Button */
        .floating-exit {
            position: absolute; top: 3vh; left: 3vh; z-index: 6000;
            background: rgba(210, 231, 214, 0.9); /* Mint with slight transparency */
            color: #1e3623; border: none; padding: 1.5vh 3.5vh; border-radius: 5vh;
            font-weight: 700; font-size: 1.8vh; cursor: pointer;
            backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .cal-box { width: 100%; height: 100%; border-radius: 2vh; overflow: hidden; background: #000; filter: invert(92%) hue-rotate(180deg) brightness(0.65); }
        
        .rec-active { animation: pulse-red 1s infinite alternate; background: #ff4b4b !important; color: #fff !important; }
        @keyframes pulse-red { from { opacity: 1; } to { opacity: 0.6; } }

        #reg-list { overflow-y: auto; flex: 1; font-size: 1.5vh; scrollbar-width: none; }
        
        /* Siren UI remains fullscreen but immersive */
        .siren-active { 
            display: none; position: fixed; inset: 0; z-index: 9999; 
            background: #600000; flex-direction: column; align-items: center; justify-content: center;
            animation: flash 0.4s infinite alternate;
        }
        @keyframes flash { from { background: #200000; } to { background: #900000; } }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="lock-clock" id="lc">00:00</div>
        <button class="unlock-pill" onclick="startSystem()">ENTER HUB</button>
    </div>

    <div class="app-shell">
        <header>
            <div class="h-time" id="ht">00:00</div>
            <div class="h-weather" id="wt">--¬∞F</div>
        </header>

        <div class="main-content">
            <aside>
                <div class="card">
                    <p class="label">System Hub</p>
                    <button class="btn btn-main" onclick="openLayer('spotify')">
                        <span style="font-size: 2vh;">‚ô´</span> Music Console
                    </button>
                    <button class="btn" id="voice-btn" onclick="runVoice()">
                        <span style="font-size: 2vh;">üé§</span> Voice Announce
                    </button>
                    <button class="btn btn-emer" onclick="openLayer('emer')">
                        <span style="font-size: 2vh;">‚ö†</span> Security Alert
                    </button>
                </div>

                <div class="card">
                    <p class="label">Dishes Cycle</p>
                    <h2 id="dish-name" style="font-size: 4.5vh; font-weight: 300; color: var(--primary); margin-bottom: 1.5vh;">---</h2>
                    <button class="btn" style="background:#fff; color:#000; justify-content: center;" onclick="nextRotation()">Complete Cycle</button>
                </div>

                <div class="card" style="flex: 1;">
                    <p class="label">Registry</p>
                    <div id="reg-list"></div>
                </div>
            </aside>

            <main class="card" style="padding: 0.5vh;">
                <div class="cal-box">
                    <iframe src="https://calendar.google.com/calendar/embed?src=family14661226943060601464%40group.calendar.google.com&ctz=America%2FNew_York&showTitle=0&showPrint=0&showTabs=0&showCalendars=0&showTz=0&bgcolor=%23ffffff" width="100%" height="100%" frameborder="0"></iframe>
                </div>
            </main>
        </div>
    </div>

    <div id="overlay-spotify" class="overlay">
        <button class="floating-exit" onclick="closeLayer('spotify')">‚Üê Exit Music</button>
        <iframe src="https://open.spotify.com/embed/playlist/3Y6Cap7vIU0hyMZvc5f6pg?utm_source=generator" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media; fullscreen;"></iframe>
    </div>

    <div id="overlay-emer" class="overlay" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.97);">
        <div style="width: 35vw; text-align: center;">
            <h1 style="color:var(--error); font-size: 4.5vh; margin-bottom: 4vh;">TACTICAL ALERT</h1>
            <button class="btn btn-emer" style="width:100%; justify-content:center; padding: 3vh;" onclick="triggerSiren('INTRUDER ALERT')">INTRUDER</button>
            <button class="btn btn-emer" style="width:100%; justify-content:center; padding: 3vh; margin-top:2vh;" onclick="triggerSiren('MEDICAL EMERGENCY')">MEDICAL</button>
            <button class="btn" style="width:100%; justify-content:center; padding: 3vh; margin-top:2vh; background:#4a3900; color:#fce99a;" onclick="triggerSiren('SHELTER IN PLACE')">SHELTER</button>
            <button class="btn" style="width:100%; justify-content:center; margin-top:5vh; background:#fff; color:#000;" onclick="closeLayer('emer')">CANCEL</button>
        </div>
    </div>

    <div id="siren-ui" class="siren-active">
        <h1 id="siren-msg" style="font-size: 8vh; font-weight: 900; color: #fff;"></h1>
        <button class="unlock-pill" style="margin-top: 8vh; background: #fff; color: #000;" onclick="stopSiren()">ALL CLEAR</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, getDoc, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDn3fqrdVcRnvkiX7t6TPJWrngXSrM_1p4", authDomain: "my-a-ab8f3.firebaseapp.com",
            projectId: "my-a-ab8f3", storageBucket: "my-a-ab8f3.firebasestorage.app",
            messagingSenderId: "65984042323", appId: "1:65984042323:web:04a6ebadc4eb29d52c3da6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let audioCtx;
        let sirenLoop;

        window.startSystem = () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('lock-screen').style.transform = 'translateY(-100%)';
        };

        // Siren Logic
        window.triggerSiren = (msg) => {
            closeLayer('emer');
            const ui = document.getElementById('siren-ui');
            ui.style.display = 'flex';
            document.getElementById('siren-msg').innerText = msg;
            
            sirenLoop = setInterval(() => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(850, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1400, audioCtx.currentTime + 0.4);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            }, 500);

            window.speechSynthesis.speak(new SpeechSynthesisUtterance(msg));
        };

        window.stopSiren = () => {
            clearInterval(sirenLoop);
            document.getElementById('siren-ui').style.display = 'none';
            window.speechSynthesis.cancel();
        };

        // Voice Engine
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        window.runVoice = () => {
            document.getElementById('voice-btn').classList.add('rec-active');
            rec.start();
        };
        rec.onresult = (e) => {
            const t = e.results[0][0].transcript;
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Announcement. " + t));
        };
        rec.onend = () => document.getElementById('voice-btn').classList.remove('rec-active');

        // UI Core
        window.openLayer = (id) => document.getElementById(`overlay-${id}`).style.display = 'flex';
        window.closeLayer = (id) => document.getElementById(`overlay-${id}`).style.display = 'none';

        function clock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            document.getElementById('lc').innerText = timeStr;
            document.getElementById('ht').innerText = timeStr;
            setTimeout(clock, 1000);
        }
        clock();

        // Data Sync
        onSnapshot(query(collection(db, "houseInfo"), orderBy("createdAt", "desc")), (s) => {
            const list = document.getElementById('reg-list'); list.innerHTML = "";
            s.forEach(d => list.innerHTML += `<div style="padding:1vh 0; border-bottom:1px solid #222"><b>${d.data().title}</b>: ${d.data().text}</div>`);
        });

        const rota = ["BRIAN", "MALAKI", "LOGAN"];
        onSnapshot(doc(db, "settings", "dishes"), (s) => {
            if(s.exists()) document.getElementById('dish-name').innerText = rota[s.data().index];
        });

        window.nextRotation = async () => {
            const s = await getDoc(doc(db, "settings", "dishes"));
            await updateDoc(doc(db, "settings", "dishes"), { index: (s.data().index + 1) % 3 });
        };
    </script>
</body>
</html>
