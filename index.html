<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Westlake Elite // Flex v15</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000000; 
            --surface: #1a1c1a; 
            --primary: #d2e7d6; 
            --on-primary: #1e3623;
            --primary-container: #3d4b3f;
            --error: #ffb4ab;
            --radius: 2.5vh;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background: var(--bg); 
            color: #e2e3dd;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Lock Screen Scaling --- */
        #lock-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .lock-clock { font-size: 15vh; font-weight: 300; color: #fff; }
        .unlock-pill {
            background: var(--primary); color: var(--on-primary); border: none;
            padding: 3vh 8vh; border-radius: 10vh; font-weight: 700; font-size: 2.5vh; cursor: pointer;
            margin-top: 5vh;
        }

        /* --- Flex Dashboard Layout --- */
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 3vh;
            gap: 2vh;
        }

        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            height: 15vh;
        }
        .h-time { font-size: clamp(40px, 10vh, 120px); font-weight: 300; line-height: 1; }
        .h-weather { font-size: 4vh; color: var(--primary); }

        .main-content {
            display: flex;
            flex: 1;
            gap: 3vh;
            min-height: 0;
        }

        aside {
            flex: 0 0 30vw;
            display: flex;
            flex-direction: column;
            gap: 2vh;
        }

        main {
            flex: 1;
            display: flex;
        }

        .card { 
            background: var(--surface); 
            border-radius: var(--radius); 
            padding: 3vh;
            display: flex; 
            flex-direction: column; 
            border: 1px solid rgba(255,255,255,0.03);
            min-height: 0;
        }

        .label { font-size: 1.2vh; font-weight: 700; color: var(--primary); margin-bottom: 1.5vh; letter-spacing: 0.2vh; text-transform: uppercase; }

        /* --- Scaling Buttons --- */
        .btn {
            background: var(--primary-container); color: var(--primary);
            border: none; padding: 2.5vh; border-radius: 2vh; font-size: 1.8vh; font-weight: 600;
            margin-bottom: 1vh; cursor: pointer; text-align: left;
        }
        .btn-main { background: var(--primary); color: var(--on-primary); }
        .btn-emer { background: #410002; color: var(--error); border: 1px solid rgba(255,180,171,0.1); }

        /* --- Overlays --- */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
        .siren-active { 
            display: none; position: fixed; inset: 0; z-index: 9999; 
            background: #600000; flex-direction: column; align-items: center; justify-content: center;
            animation: flash 0.5s infinite alternate;
        }
        @keyframes flash { from { background: #300000; } to { background: #900000; } }

        .cal-box { width: 100%; height: 100%; border-radius: 2vh; overflow: hidden; background: #000; filter: invert(92%) hue-rotate(180deg) brightness(0.65); }
        
        .recording-pulse { animation: rec 1s infinite alternate; background: #ff4b4b !important; color: #fff !important; }
        @keyframes rec { from { opacity: 1; } to { opacity: 0.6; } }

        #reg-list { overflow-y: auto; flex: 1; font-size: 1.6vh; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="lock-clock" id="lc">00:00</div>
        <button class="unlock-pill" onclick="startSystem()">INITIALIZE SYSTEM</button>
    </div>

    <div class="app-shell">
        <header>
            <div class="h-time" id="ht">00:00</div>
            <div class="h-weather" id="wt">--¬∞F</div>
        </header>

        <div class="main-content">
            <aside>
                <div class="card">
                    <p class="label">Operations</p>
                    <button class="btn btn-main" onclick="openLayer('spotify')">Music Terminal</button>
                    <button class="btn" id="voice-btn" onclick="runVoice()">üé§ Voice Announce</button>
                    <button class="btn btn-emer" onclick="openLayer('emer')">Emergency Matrix</button>
                </div>

                <div class="card">
                    <p class="label">Kitchen Rotation</p>
                    <h2 id="dish-name" style="font-size: 5vh; font-weight: 300; color: var(--primary); margin-bottom: 1vh;">---</h2>
                    <button class="btn" style="background:#fff; color:#000; text-align:center; padding: 1.5vh;" onclick="nextRotation()">Complete Cycle</button>
                </div>

                <div class="card" style="flex: 1;">
                    <p class="label">House Registry</p>
                    <div id="reg-list"></div>
                </div>
            </aside>

            <main class="card" style="padding: 1vh;">
                <div class="cal-box">
                    <iframe src="https://calendar.google.com/calendar/embed?src=family14661226943060601464%40group.calendar.google.com&ctz=America%2FNew_York&showTitle=0&showPrint=0&showTabs=0&showCalendars=0&showTz=0&bgcolor=%23ffffff" width="100%" height="100%" frameborder="0"></iframe>
                </div>
            </main>
        </div>
    </div>

    <div id="overlay-spotify" class="overlay">
        <div style="padding:4vh;"><button class="unlock-pill" onclick="closeLayer('spotify')">‚Üê Back to Hub</button></div>
        <iframe src="https://open.spotify.com/embed/playlist/3Y6Cap7vIU0hyMZvc5f6pg?utm_source=generator" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media; fullscreen;"></iframe>
    </div>

    <div id="overlay-emer" class="overlay" style="align-items: center; justify-content: center; background: rgba(0,0,0,0.95);">
        <div style="width: 40vw; text-align: center;">
            <h1 style="color:var(--error); font-size: 5vh; margin-bottom: 4vh;">Tactical Selection</h1>
            <button class="btn btn-emer" style="width:100%; text-align:center; padding: 4vh;" onclick="triggerSiren('INTRUDER ALERT')">INTRUDER</button>
            <button class="btn btn-emer" style="width:100%; text-align:center; padding: 4vh; margin-top:2vh;" onclick="triggerSiren('MEDICAL EMERGENCY')">MEDICAL</button>
            <button class="btn" style="width:100%; text-align:center; padding: 4vh; margin-top:2vh; background:#4a3900; color:#fce99a;" onclick="triggerSiren('SHELTER IN PLACE')">SHELTER</button>
            <button class="btn" style="width:100%; text-align:center; margin-top:5vh; background:#fff; color:#000;" onclick="closeLayer('emer')">CANCEL</button>
        </div>
    </div>

    <div id="siren-ui" class="siren-active">
        <h1 id="siren-msg" style="font-size: 8vh; font-weight: 900; color: #fff; text-align: center; padding: 0 5vw;"></h1>
        <button class="unlock-pill" style="margin-top: 10vh; background: #fff; color: #000;" onclick="stopSiren()">STOP ALL ALARMS</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, getDoc, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDn3fqrdVcRnvkiX7t6TPJWrngXSrM_1p4", authDomain: "my-a-ab8f3.firebaseapp.com",
            projectId: "my-a-ab8f3", storageBucket: "my-a-ab8f3.firebasestorage.app",
            messagingSenderId: "65984042323", appId: "1:65984042323:web:04a6ebadc4eb29d52c3da6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let audioCtx;
        let sirenLoop;

        // Startup
        window.startSystem = () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('lock-screen').style.transform = 'translateY(-100%)';
        };

        // Siren Engine
        window.triggerSiren = (msg) => {
            closeLayer('emer');
            const ui = document.getElementById('siren-ui');
            ui.style.display = 'flex';
            document.getElementById('siren-msg').innerText = msg;
            
            sirenLoop = setInterval(() => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(900, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            }, 600);

            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Warning. " + msg));
        };

        window.stopSiren = () => {
            clearInterval(sirenLoop);
            document.getElementById('siren-ui').style.display = 'none';
            window.speechSynthesis.cancel();
        };

        // Voice
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        window.runVoice = () => {
            document.getElementById('voice-btn').classList.add('recording-pulse');
            rec.start();
        };
        rec.onresult = (e) => {
            const t = e.results[0][0].transcript;
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Announcement: " + t));
        };
        rec.onend = () => document.getElementById('voice-btn').classList.remove('recording-pulse');

        // UI Core
        window.openLayer = (id) => document.getElementById(`overlay-${id}`).style.display = 'flex';
        window.closeLayer = (id) => document.getElementById(`overlay-${id}`).style.display = 'none';

        function clock() {
            const now = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            document.getElementById('lc').innerText = now;
            document.getElementById('ht').innerText = now;
            setTimeout(clock, 1000);
        }
        clock();

        // Firebase
        onSnapshot(query(collection(db, "houseInfo"), orderBy("createdAt", "desc")), (s) => {
            const list = document.getElementById('reg-list'); list.innerHTML = "";
            s.forEach(d => list.innerHTML += `<div style="padding:1.5vh 0; border-bottom:1px solid #333"><b>${d.data().title}</b>: ${d.data().text}</div>`);
        });

        const users = ["BRIAN", "MALAKI", "LOGAN"];
        onSnapshot(doc(db, "settings", "dishes"), (s) => {
            if(s.exists()) document.getElementById('dish-name').innerText = users[s.data().index];
        });

        window.nextRotation = async () => {
            const s = await getDoc(doc(db, "settings", "dishes"));
            await updateDoc(doc(db, "settings", "dishes"), { index: (s.data().index + 1) % 3 });
        };
    </script>
</body>
</html>
