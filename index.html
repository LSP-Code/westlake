<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Westlake Elite Tactical</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000000; --surface: #1a1c1a; --primary: #d2e7d6; 
            --on-primary: #1e3623; --primary-container: #3d4b3f;
            --error: #ffb4ab; --radius: 28px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: #e2e3dd; height: 100dvh; width: 100vw; overflow: hidden; }

        /* --- Lock Screen --- */
        #lock-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .lock-clock { font-size: 120px; font-weight: 300; margin-bottom: 20px; color: #fff; }
        .unlock-pill {
            background: var(--primary); color: var(--on-primary); border: none;
            padding: 24px 60px; border-radius: 50px; font-weight: 700; font-size: 18px; cursor: pointer;
        }

        /* --- Layout --- */
        .app-container { display: grid; grid-template-columns: 400px 1fr; grid-template-rows: auto 1fr; gap: 24px; height: 100%; padding: 30px; }
        header { grid-column: span 2; display: flex; justify-content: space-between; align-items: flex-end; }
        .h-time { font-size: 82px; font-weight: 300; line-height: 1; }

        .card { 
            background: var(--surface); border-radius: var(--radius); padding: 25px;
            display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.03);
            min-height: 0;
        }
        .label { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 15px; letter-spacing: 1.5px; text-transform: uppercase; }

        .btn {
            background: var(--primary-container); color: var(--primary);
            border: none; padding: 22px; border-radius: 22px; font-size: 16px; font-weight: 600;
            margin-bottom: 12px; cursor: pointer; text-align: left;
        }
        .btn-main { background: var(--primary); color: var(--on-primary); }
        .btn-emer { background: #410002; color: var(--error); border: 1px solid rgba(255,180,171,0.1); }

        /* --- Overlays --- */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
        .active-siren-overlay { 
            display: none; position: fixed; inset: 0; z-index: 9999; 
            background: #600000; flex-direction: column; align-items: center; justify-content: center;
            animation: pulse-red 0.5s infinite alternate;
        }
        @keyframes pulse-red { from { background: #400000; } to { background: #a00000; } }

        .cal-box { width: 100%; height: 100%; border-radius: 20px; overflow: hidden; background: #000; filter: invert(92%) hue-rotate(180deg) brightness(0.6); }
        .recording { animation: pulse-mic 1.5s infinite; background: #ff4b4b !important; color: white !important; }
        @keyframes pulse-mic { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="lock-clock" id="lc">00:00</div>
        <button class="unlock-pill" onclick="unlockSystem()">Unlock & Initialize</button>
    </div>

    <div class="app-container">
        <header>
            <div class="h-time" id="ht">00:00</div>
            <div id="wt" style="font-size: 28px; color: var(--primary);">--¬∞F</div>
        </header>

        <aside style="display: flex; flex-direction: column; gap: 24px; min-height: 0;">
            <div class="card">
                <p class="label">Operations</p>
                <button class="btn btn-main" onclick="openLayer('spotify')">Music Terminal</button>
                <button class="btn" id="voice-btn" onclick="startVoice()">üé§ Voice Announce</button>
                <button class="btn btn-emer" onclick="openLayer('emer')">Emergency Ops</button>
            </div>

            <div class="card">
                <p class="label">Dishes</p>
                <h2 id="dish-user" style="font-size: 48px; font-weight: 300; color: var(--primary); margin-bottom: 10px;">---</h2>
                <button class="btn" style="background:#fff; color:#000; text-align:center;" onclick="rotateUser()">Mark Done</button>
            </div>

            <div class="card" style="flex-grow: 1;">
                <p class="label">Registry</p>
                <div id="reg-list" style="overflow-y:auto; font-size: 14px;"></div>
            </div>
        </aside>

        <main class="card" style="padding: 10px;">
            <div class="cal-box">
                <iframe src="https://calendar.google.com/calendar/embed?src=family14661226943060601464%40group.calendar.google.com&ctz=America%2FNew_York&showTitle=0&showPrint=0&showTabs=0&showCalendars=0&showTz=0&bgcolor=%23ffffff" width="100%" height="100%" frameborder="0"></iframe>
            </div>
        </main>
    </div>

    <div id="overlay-spotify" class="overlay">
        <div style="padding:30px;"><button class="unlock-pill" onclick="closeLayer('spotify')">‚Üê Back</button></div>
        <iframe src="https://open.spotify.com/embed/playlist/3Y6Cap7vIU0hyMZvc5f6pg?utm_source=generator" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media; fullscreen;"></iframe>
    </div>

    <div id="overlay-emer" class="overlay" style="align-items: center; justify-content: center; background: rgba(0,0,0,0.95);">
        <div style="width: 450px; text-align: center;">
            <h1 style="color:var(--error); font-size: 38px; margin-bottom: 30px;">Tactical Select</h1>
            <button class="btn btn-emer" style="width:100%; text-align:center;" onclick="activateSiren('INTRUDER ALERT')">Intruder</button>
            <button class="btn btn-emer" style="width:100%; text-align:center; margin-top:10px;" onclick="activateSiren('MEDICAL EMERGENCY')">Medical</button>
            <button class="btn" style="width:100%; text-align:center; background:#4a3900; color:#fce99a; margin-top:10px;" onclick="activateSiren('SHELTER IN PLACE')">Shelter</button>
            <button class="btn" style="width:100%; text-align:center; background:#fff; color:#000; margin-top:30px;" onclick="closeLayer('emer')">Cancel</button>
        </div>
    </div>

    <div id="siren-display" class="active-siren-overlay">
        <h1 id="siren-text" style="font-size: 70px; font-weight: 900; color: #fff; text-align: center;"></h1>
        <button class="unlock-pill" style="margin-top: 50px; background: #fff; color: #000;" onclick="killSiren()">ALL CLEAR / STOP AUDIO</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, getDoc, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDn3fqrdVcRnvkiX7t6TPJWrngXSrM_1p4", authDomain: "my-a-ab8f3.firebaseapp.com",
            projectId: "my-a-ab8f3", storageBucket: "my-a-ab8f3.firebasestorage.app",
            messagingSenderId: "65984042323", appId: "1:65984042323:web:04a6ebadc4eb29d52c3da6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // SIREN ENGINE
        let audioCtx;
        let sirenInterval;

        window.unlockSystem = () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.documentElement.requestFullscreen().catch(() => {});
            document.getElementById('lock-screen').style.transform = 'translateY(-100%)';
        };

        window.activateSiren = (msg) => {
            closeLayer('emer');
            document.getElementById('siren-display').style.display = 'flex';
            document.getElementById('siren-text').innerText = msg;
            
            sirenInterval = setInterval(() => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1400, audioCtx.currentTime + 0.4);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            }, 500);

            const speech = new SpeechSynthesisUtterance("Warning. " + msg);
            window.speechSynthesis.speak(speech);
        };

        window.killSiren = () => {
            clearInterval(sirenInterval);
            document.getElementById('siren-display').style.display = 'none';
            window.speechSynthesis.cancel();
        };

        // VOICE
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        window.startVoice = () => {
            document.getElementById('voice-btn').classList.add('recording');
            rec.start();
        };
        rec.onresult = (e) => {
            const t = e.results[0][0].transcript;
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Announcement: " + t));
        };
        rec.onend = () => document.getElementById('voice-btn').classList.remove('recording');

        // UI & FIREBASE
        window.openLayer = (id) => document.getElementById(`overlay-${id}`).style.display = 'flex';
        window.closeLayer = (id) => document.getElementById(`overlay-${id}`).style.display = 'none';

        function tick() {
            const now = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            document.getElementById('lc').innerText = now;
            document.getElementById('ht').innerText = now;
            setTimeout(tick, 1000);
        }
        tick();

        onSnapshot(query(collection(db, "houseInfo"), orderBy("createdAt", "desc")), (s) => {
            const l = document.getElementById('reg-list'); l.innerHTML = "";
            s.forEach(d => l.innerHTML += `<div style="padding:10px 0; border-bottom:1px solid #333"><b>${d.data().title}</b>: ${d.data().text}</div>`);
        });

        const rota = ["BRIAN", "MALAKI", "LOGAN"];
        onSnapshot(doc(db, "settings", "dishes"), (s) => {
            if(s.exists()) document.getElementById('dish-user').innerText = rota[s.data().index];
        });

        window.rotateUser = async () => {
            const s = await getDoc(doc(db, "settings", "dishes"));
            await updateDoc(doc(db, "settings", "dishes"), { index: (s.data().index + 1) % 3 });
        };
    </script>
</body>
</html>
